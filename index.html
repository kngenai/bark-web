<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bark Translator ‚Äî Web üê∂</title>
  <meta name="description" content="A playful dog bark translator tailored to breed, traits, and your Woof-Meter." />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="wrap">
    <h1>Dog Bark Translator üê∂</h1>
    <p class="sub">Pick a breed, tap a few traits, dial in the Woof-Meter, then translate. <em>Entertainment only!</em></p>

    <section class="controls" aria-label="Inputs">
      <!-- Breed -->
      <label for="breed">Dog breed</label>
      <select id="breed" class="select" aria-label="Dog breed">
        <option value="">‚Äî Select a breed ‚Äî</option>
        <option>Labrador Retriever</option>
        <option>Golden Retriever</option>
        <option>German Shepherd</option>
        <option>French Bulldog</option>
        <option>Beagle</option>
        <option>Poodle</option>
        <option>Husky</option>
        <option>Border Collie</option>
        <option>Corgi</option>
        <option>Dachshund</option>
        <option>Shiba</option>
        <option>Australian Shepherd</option>
        <option>Boxer</option>
        <option>Rottweiler</option>
        <option>Great Dane</option>
      </select>

      <!-- Traits (chips only) -->
      <label>Personality (tap a few)</label>
      <div class="chips" id="traitChips" role="group" aria-label="Personality traits">
        <button data-trait="goofy">goofy</button>
        <button data-trait="food-motivated">food-motivated</button>
        <button data-trait="squirrel-obsessed">squirrel-obsessed</button>
        <button data-trait="clingy">clingy</button>
        <button data-trait="zoomies">zoomies</button>
        <button data-trait="water-lover">water-lover</button>
        <button data-trait="guard dog vibes">guard dog vibes</button>
        <button data-trait="dramatic talker">dramatic talker</button>
        <button data-trait="nose-driven">nose-driven</button>
        <button data-trait="cuddle bug">cuddle bug</button>
      </div>

      <!-- Woof-Meter -->
      <div class="meter">
        <div class="meter-row" role="group" aria-label="Woof count">
          <div class="meter-label">Count</div>
          <div class="seg" id="countSeg">
            <button data-val="one_woof" aria-pressed="false">One woof</button>
            <button data-val="two_woofs" aria-pressed="true" class="on">Two woofs</button>
            <button data-val="pack_chorus" aria-pressed="false">Pack chorus</button>
          </div>
          <small class="hint">How many borks were aired.</small>
        </div>

        <div class="meter-row" role="group" aria-label="Pitch">
          <div class="meter-label">Pitch</div>
          <div class="seg" id="pitchSeg">
            <button data-val="squeaky">Squeaky üê≠</button>
            <button data-val="middle" class="on">Middle üé∫</button>
            <button data-val="thunder">Thunder üí•</button>
          </div>
          <small class="hint">From tiny squeak to subwoofer thunder.</small>
        </div>

        <div class="meter-row" role="group" aria-label="Urgency">
          <div class="meter-label">Urgency</div>
          <div class="seg" id="urgencySeg">
            <button data-val="casual_sniff">Casual sniff</button>
            <button data-val="snack_request" class="on">Snack request</button>
            <button data-val="snack_emergency">Snack emergency</button>
          </div>
          <small class="hint">Snack escalation protocol.</small>
        </div>

        <div class="meter-row" role="group" aria-label="Mood">
          <div class="meter-label">Mood</div>
          <div class="seg" id="moodSeg">
            <button data-val="chill" class="on">Chill</button>
            <button data-val="alert">Alert</button>
            <button data-val="drama_queen">Drama queen</button>
          </div>
          <small class="hint">Overall bark vibe.</small>
        </div>

        <div class="meter-row" role="group" aria-label="Squirrel probability">
          <div class="meter-label">Squirrel %</div>
          <div class="seg" id="squirrelSeg">
            <button data-val="0">0%</button>
            <button data-val="50" class="on">50%</button>
            <button data-val="100">100%</button>
          </div>
          <small class="hint">Scientifically dubious, emotionally accurate.</small>
        </div>

        <div class="meter-row" role="group" aria-label="Zoomies">
          <div class="meter-label">Zoomies</div>
          <div class="zoom">
            <input id="zoomies" type="range" min="0" max="10" value="5" step="1" />
            <div id="zoomLabel" class="zoom-label">5 ¬∑ Wigglebutt</div>
          </div>
          <small class="hint">0‚Äì2: Couch potato ¬∑ 3‚Äì6: Wigglebutt ¬∑ 7‚Äì10: Tornado</small>
        </div>

        <div class="meter-actions">
          <button id="randomizeWoof" class="btn ghost" aria-label="Randomize Woof-Meter">üé≤ Randomize woof</button>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <div></div>
        <button id="translateBtn" class="btn btn-primary">Translate</button>
      </div>
    </section>

    <section class="result" aria-live="polite">
      <div class="result-head"><b>Translation:</b></div>
      <div id="reply" class="bubble">‚Äî</div>

      <!-- Speaking animation (local asset recommended) -->
      <div id="speakAnim" class="speak-anim" aria-hidden="true">
        <img src="/assets/dog-blah-blah-blah.gif" />
        <img src="/assets/dog-talk-dog.gif" />
        <img src="/assets/talking-ben.gif" />
        <img src="/assets/dog-phone.gif" />
      </div>
    </section>

    <div id="banner" class="banner" style="display:none;"></div>
    <p class="small">No health or training advice. Just jokes.</p>
  </main>

<script>
  // ==== Config ====
  const ENABLE_AUDIO = false;                 // hard-disable audio/GIFs
  const CLIENT_TIMEOUT_MS = 12000;            // abort slow requests
  const PREFERS_REDUCED =
    window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches || false;

  // --- Elements ---
  const breedEl = document.getElementById('breed');
  const chipsEl = document.getElementById('traitChips');
  const replyEl = document.getElementById('reply');
  const banner = document.getElementById('banner');
  const translateBtn = document.getElementById('translateBtn');
  const speakAnim = document.getElementById('speakAnim');
  const zoomiesEl = document.getElementById('zoomies');
  const zoomLabelEl = document.getElementById('zoomLabel');

  // Hide the speaking animation box entirely if audio disabled
  if (speakAnim && !ENABLE_AUDIO) {
    speakAnim.style.display = 'none';
  }

  // segmented groups
  const segGroups = {
    count: document.getElementById('countSeg'),
    pitch: document.getElementById('pitchSeg'),
    urgency: document.getElementById('urgencySeg'),
    mood: document.getElementById('moodSeg'),
    squirrel: document.getElementById('squirrelSeg'),
  };

  // Trait chips toggle
  chipsEl.addEventListener('click', (e)=>{
    if (e.target.tagName !== 'BUTTON') return;
    e.target.classList.toggle('chip-on');
  });
  const getSelectedTraits = () =>
    Array.from(chipsEl.querySelectorAll('.chip-on')).map(b => b.dataset.trait);

  // Segmented controls (one active)
  for (const key in segGroups) {
    segGroups[key].addEventListener('click', e => {
      if (e.target.tagName !== 'BUTTON') return;
      segGroups[key].querySelectorAll('button').forEach(b => {
        b.classList.remove('on');
        // ARIA: radio semantics for better a11y
        b.setAttribute('aria-checked','false');
      });
      e.target.classList.add('on');
      e.target.setAttribute('aria-checked','true');
    });
  }

  // Zoomies live label
  function zoomLabel(v){
    const n = Number(v);
    const bucket = n <= 2 ? 'Couch potato' : n <= 6 ? 'Wigglebutt' : 'Tornado';
    zoomLabelEl.textContent = `${n} ¬∑ ${bucket}`;
  }
  zoomiesEl.addEventListener('input', e => zoomLabel(e.target.value));
  zoomLabel(zoomiesEl.value);

  // Helpers
  function setDisabled(disabled){
    const allButtons = Array.from(document.querySelectorAll('button, select, input[type="range"]'));
    allButtons.forEach(el => el.disabled = disabled);
  }
  function setThinking(on){
    if (on) { replyEl.classList.add('thinking'); replyEl.textContent = 'Translating‚Ä¶'; }
    else { replyEl.classList.remove('thinking'); }
  }
  async function typeWriter(el, text, speed = 40) {
    if (PREFERS_REDUCED) { el.textContent = text; return; }
    el.textContent = "";
    for (let i = 0; i < text.length; i++) {
      el.textContent += text[i];
      // eslint-disable-next-line no-await-in-loop
      await new Promise(r => setTimeout(r, speed));
    }
  }
  // No-op: audio + GIFs disabled
  function speak(_text){ /* intentionally disabled */ }

  function readSeg(groupEl, fallback){
    const on = groupEl.querySelector('.on');
    return on ? (on.dataset.val ?? fallback) : fallback;
  }

  // Build payload
  function buildPayload(){
    return {
      breed: (breedEl.value || '').trim(),
      traits: getSelectedTraits().join(', '),
      woofMeter: {
        count: readSeg(segGroups.count, 'two_woofs'),
        pitch: readSeg(segGroups.pitch, 'middle'),
        urgency: readSeg(segGroups.urgency, 'snack_request'),
        mood: readSeg(segGroups.mood, 'chill'),
        squirrel: readSeg(segGroups.squirrel, '50'),
        zoomies: Number(zoomiesEl.value || 5)
      }
    };
  }

  // Local persistence (nice touch)
  const STORAGE_KEY = 'bark-translator-v1';
  function saveState(){
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(buildPayload())); } catch {}
  }
  function loadState(){
    try {
      const state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      if (!state || typeof state !== 'object') return;
      if (state.breed) breedEl.value = state.breed;
      (state.traits || '').split(',').map(s=>s.trim()).filter(Boolean).forEach(tr => {
        const btn = chipsEl.querySelector(`[data-trait="${CSS.escape(tr)}"]`);
        if (btn) btn.classList.add('chip-on');
      });
      const map = [
        ['count','countSeg','two_woofs'],
        ['pitch','pitchSeg','middle'],
        ['urgency','urgencySeg','snack_request'],
        ['mood','moodSeg','chill'],
        ['squirrel','squirrelSeg','50'],
      ];
      map.forEach(([k, id, fb])=>{
        const seg = document.getElementById(id);
        const val = state.woofMeter?.[k] ?? fb;
        const btn = seg?.querySelector(`button[data-val="${val}"]`);
        if (btn) btn.click();
      });
      const z = Number(state.woofMeter?.zoomies ?? 5);
      zoomiesEl.value = z; zoomLabel(z);
    } catch {}
  }
  breedEl.addEventListener('change', saveState);
  chipsEl.addEventListener('click', saveState);
  Object.values(segGroups).forEach(el => el.addEventListener('click', saveState));
  zoomiesEl.addEventListener('input', saveState);
  loadState();

  // Fetch with cache-busting + timeout + proper error handling
  async function doTranslate() {
    const payload = buildPayload();

    // tiny delay so thinking is visible
    await new Promise(r => setTimeout(r, 300 + Math.random()*400));

    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort(), CLIENT_TIMEOUT_MS);
    const res = await fetch(`/api/translate?ts=${Date.now()}`, {
  method: 'POST',
  headers: { 'Content-Type':'application/json' },
  cache: 'no-store',        // hint to browser
  body: JSON.stringify(payload)
});


    if (res.status === 429) {
      const data = await res.json().catch(()=> ({}));
      const msg = data?.reply || "Too many barks. Try again soon.";
      const seconds = Number(data?.retryAfter || 0);

      banner.style.display = 'block';
      if (seconds > 0) {
        let remaining = seconds;
        banner.textContent = `${msg} (${remaining}s)`;
        const countdown = setInterval(()=>{
          remaining--;
          banner.textContent = `${msg} (${Math.max(remaining,0)}s)`;
          if (remaining <= 0) clearInterval(countdown);
        }, 1000);
      } else {
        banner.textContent = msg;
      }

      await typeWriter(replyEl, msg, 35);
      speak(msg); // no-op
      return;
    } else {
      banner.style.display = 'none';
    }

    if (!res.ok) {
      const data = await res.json().catch(()=> ({}));
      const msg = data?.reply || 'Server had a squirrel moment. Try again.';
      await typeWriter(replyEl, msg, 35);
      speak(msg); // no-op
      return;
    }

    const data = await res.json();
    const line = (data && data.reply) ? data.reply : '(*head tilt*) Try another bark.';
    await typeWriter(replyEl, line, 40);
    speak(line); // no-op
  }

  async function translate(){
    try { setDisabled(true); setThinking(true); await doTranslate(); }
    catch (e) {
      const msg = (e && e.name === 'AbortError')
        ? 'The park got too far away (timeout). Try again.'
        : 'Network squirrels chewed the cable. Try again.';
      replyEl.textContent = msg; speak(msg);
      banner.style.display = 'block'; banner.textContent = msg;
    } finally { setThinking(false); setDisabled(false); }
  }

  translateBtn.onclick = () => translate();

  // Randomize Woof-Meter (no API call)
  document.getElementById('randomizeWoof').onclick = ()=>{
    for (const key in segGroups) {
      const btns = Array.from(segGroups[key].querySelectorAll('button'));
      const pick = btns[Math.floor(Math.random()*btns.length)];
      btns.forEach(b => { b.classList.remove('on'); b.setAttribute('aria-checked','false'); });
      pick.classList.add('on'); pick.setAttribute('aria-checked','true');
    }
    const z = Math.floor(Math.random()*11);
    zoomiesEl.value = z; zoomLabel(z);
    saveState();
  };

  // Keyboard: Enter to submit
  document.addEventListener('keydown', (e)=>{
    // avoid triggering while typing in selects/inputs
    const tag = (document.activeElement?.tagName || '').toLowerCase();
    if (e.key === 'Enter' && !e.shiftKey && !['input','select','textarea','button'].includes(tag)) {
      translateBtn.click();
    }
  });
</script>

</body>
</html>



